<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>
openvpn 2fa &middot; IT notes
</title>
    <link rel="stylesheet" href="https://nbari.com/slim.css">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet'
        type='text/css'>
    
    
</head>

<body>
    <div class="container">
        
<div class="header">
    <h1 class="site-title"><a href="https:&#x2F;&#x2F;nbari.com">IT notes</a></h1>
    <p class="site-tagline"></p>
    <div class="nav">
        <a class="nav-btn" href="#">
            <span class="ci ci-burger"></span>
        </a>
        <ul class="nav-list">
            
            
            <li><a href="https:&#x2F;&#x2F;nbari.com&#x2F;about&#x2F;">About</a></li>
            
            <li><a href="https:&#x2F;&#x2F;nbari.com&#x2F;tags">Tags</a></li>
            
            
            <li class="spacer">&ac;</li>
            
            
            <li><a href="https://github.com/nbari">Github</a></li>
            
            
        </ul>
    </div>
</div>

        <div class="content">
            <div class="posts">
                
<div class="post">
    
    
<h2 class="post-title"><a href="https:&#x2F;&#x2F;nbari.com&#x2F;openvpn-2fa&#x2F;">openvpn 2fa</a></h2>
<div class="post-header">
    <span class="post-date">November 13, 2017</span>
    
    <div class="post-tags">
        
        <span class="post-tag">#<a href="https://nbari.com/tags/vpn/">vpn</a></span>
        
        <span class="post-tag">#<a href="https://nbari.com/tags/openvpn/">openvpn</a></span>
        
        <span class="post-tag">#<a href="https://nbari.com/tags/2fa/">2fa</a></span>
        
    </div>
    
</div>

    <div class="post-content">
        <p>Setup OpenVPN + 2fa</p>
<p>The way it works is that openvpn besides only allowing guest with a valid
certificate it will prompt users for a username and password in where username is
a system user and password is the OTP generated by the google authenticator.</p>
<p>First you need to install <code>google-authenticator</code>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>pkg install pam_google_authenticator
</span></code></pre>
<p>Next create the file <code>/etc/pam.d/openvpn</code> with this contents:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>auth            required        /usr/local/lib/pam_google_authenticator.so
</span></code></pre>
<p>The openvpn configuration should look like this:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># ------------------------------------------------------------------------------
</span><span style="color:#65737e;"># routed VPN
</span><span style="color:#65737e;"># ------------------------------------------------------------------------------
</span><span style="color:#bf616a;">port</span><span> 1194
</span><span style="color:#bf616a;">proto</span><span> udp
</span><span style="color:#bf616a;">dev</span><span> tun
</span><span style="color:#bf616a;">topology</span><span> subnet
</span><span style="color:#bf616a;">server</span><span> 172.16.13.0 255.255.255.0
</span><span style="color:#bf616a;">tun-mtu</span><span> 1400
</span><span>
</span><span style="color:#bf616a;">ca</span><span> keys/ca.crt
</span><span style="color:#bf616a;">cert</span><span> keys/server.crt
</span><span style="color:#bf616a;">key</span><span> keys/server.key
</span><span style="color:#bf616a;">dh</span><span> keys/dh2048.pem
</span><span style="color:#bf616a;">tls-auth</span><span> keys/ta.key 0
</span><span style="color:#bf616a;">key-direction</span><span> 0
</span><span>
</span><span style="color:#bf616a;">push </span><span>&quot;</span><span style="color:#a3be8c;">dhcp-option DNS 4.2.2.2</span><span>&quot;
</span><span style="color:#bf616a;">push </span><span>&quot;</span><span style="color:#a3be8c;">dhcp-option DNS 8.8.8.8</span><span>&quot;
</span><span style="color:#bf616a;">push </span><span>&quot;</span><span style="color:#a3be8c;">redirect-gateway def1</span><span>&quot;
</span><span>
</span><span style="color:#bf616a;">client-config-dir</span><span> ccd
</span><span style="color:#bf616a;">plugin</span><span> /usr/local/lib/openvpn/plugins/openvpn-plugin-auth-pam.so openvpn
</span><span style="color:#bf616a;">duplicate-cn
</span><span>
</span><span style="color:#bf616a;">cipher</span><span> AES-256-CBC
</span><span style="color:#bf616a;">auth</span><span> SHA512
</span><span>
</span><span style="color:#bf616a;">comp-lzo
</span><span style="color:#bf616a;">max-clients</span><span> 100
</span><span style="color:#bf616a;">user</span><span> nobody
</span><span style="color:#bf616a;">group</span><span> nobody
</span><span style="color:#bf616a;">persist-key
</span><span style="color:#bf616a;">persist-tun
</span><span style="color:#bf616a;">status</span><span> openvpn-status.log
</span><span style="color:#bf616a;">verb</span><span> 4
</span><span style="color:#bf616a;">keepalive</span><span> 20 40
</span><span>
</span><span style="color:#65737e;"># certificate revoking list
</span><span style="color:#65737e;"># crl-verify keys/crl.pem
</span></code></pre>
<p>Notice the line:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>plugin /usr/local/lib/openvpn/plugins/openvpn-plugin-auth-pam.so openvpn
</span></code></pre>
<p>The client side should be something like this:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">client
</span><span style="color:#bf616a;">dev</span><span> tun
</span><span style="color:#bf616a;">proto</span><span> udp
</span><span style="color:#bf616a;">remote</span><span> X.X.X.X 1194
</span><span style="color:#bf616a;">resolv-retry</span><span> infinite
</span><span style="color:#bf616a;">nobind
</span><span style="color:#bf616a;">persist-key
</span><span style="color:#bf616a;">persist-tun
</span><span style="color:#bf616a;">comp-lzo
</span><span style="color:#bf616a;">key-direction</span><span> 1
</span><span style="color:#bf616a;">cipher</span><span> AES-256-CBC
</span><span style="color:#bf616a;">auth</span><span> SHA512
</span><span style="color:#bf616a;">verb</span><span> 3
</span><span style="color:#bf616a;">auth-user-pass
</span><span style="color:#bf616a;">auth-nocache
</span><span>&lt;ca&gt;
</span><span style="color:#bf616a;">-----BEGIN</span><span> CERTIFICATE-----
</span><span style="color:#bf616a;">-----END</span><span> CERTIFICATE-----
</span><span>&lt;/ca&gt;
</span><span>&lt;cert&gt;
</span><span style="color:#bf616a;">-----BEGIN</span><span> CERTIFICATE-----
</span><span style="color:#bf616a;">-----END</span><span> CERTIFICATE-----
</span><span>&lt;/cert&gt;
</span><span>&lt;key&gt;
</span><span style="color:#bf616a;">-----BEGIN</span><span> PRIVATE KEY-----
</span><span style="color:#bf616a;">-----END</span><span> PRIVATE KEY-----
</span><span>&lt;/key&gt;
</span><span>&lt;tls-auth&gt;
</span><span style="color:#bf616a;">-----BEGIN</span><span> OpenVPN Static key V1-----
</span><span style="color:#bf616a;">-----END</span><span> OpenVPN Static key V1-----
</span><span>&lt;/tls-auth&gt;
</span></code></pre>
<p>Notice the:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>auth-user-pass
</span><span>auth-nocache
</span></code></pre>
<h3 id="add-users-create-sign-certs"><a class="zola-anchor" href="#add-users-create-sign-certs" aria-label="Anchor link for: add-users-create-sign-certs">ðŸ”—</a>Add users (create &amp; sign certs)</h3>
<p>First create user certificate by doing something like (this can be created by user and the admin could only sign the cert):</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>openssl req -new -newkey rsa:2048 -nodes -out guest.csr -keyout guest.key -subj &quot;/C=DE/ST=Germany/L=Berlin/O=acme/OU=IT/CN=guest&quot;
</span></code></pre>
<p>With the server key you need to sign the <code>guest.csr</code>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>openssl x509 -req -in guest.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out users/guest.crt -days 7
</span></code></pre>
<p>In this case the <code>guest.crt</code> will be only valid for 7 days.</p>
<h3 id="create-the-2fa-codes-for-the-user"><a class="zola-anchor" href="#create-the-2fa-codes-for-the-user" aria-label="Anchor link for: create-the-2fa-codes-for-the-user">ðŸ”—</a>create the 2fA codes for the user</h3>
<p>The easy way is to create / add user to the system <code>adduser</code>, once the user has been created you could run this command:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>su - guest -c google-authenticator
</span></code></pre>
<p>This will create a file in the <code>guest</code> user $HOME: <code>/home/test/.google_authenticator</code>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat .google_authenticator
</span><span>35NIQ7S2T44WT5ZC
</span><span>&quot; RATE_LIMIT 3 30 1510594908 1510594922
</span><span>&quot; WINDOW_SIZE 17
</span><span>&quot; DISALLOW_REUSE 50353163
</span><span>&quot; TOTP_AUTH
</span><span>53344656
</span><span>94746893
</span><span>13420893
</span><span>11387169
</span><span>23988009
</span></code></pre>
<p>The <code>35NIQ7S2T44WT5ZC</code> is the seed / code you need to use within your app that
generates the codes for example in authy it will be here:</p>
<p><img src="/img/authy-enter-code.png" alt="authy enter code" /></p>
<p>This should be enough for a starting point.</p>
<p>To test that the <code>pam</code> settings are working you could use <code>pamtester</code>, for example:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># pamtester -v openvpn guest authenticate
</span><span>pamtester: invoking pam_start(openvpn, test, ...)
</span><span>pamtester: performing operation - authenticate
</span><span>Verification code:
</span><span>pamtester: successfully authenticated
</span></code></pre>
<p>The verification code should be the one generated by your application.</p>

    </div>
    
</div>

            </div>
            
        </div>
        
<div class="footer">
    
    <p>ðŸŒ±</p>
    
</div>

    </div>
    <script src="https://nbari.com/js/slim.js"></script>
    
</body>

</html>